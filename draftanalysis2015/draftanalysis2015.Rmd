---
title: "Jeff Cup Year 10 Draft Analysis"
output: 
  html_document: 
    theme: flatly
runtime: shiny
---

```{r global_opts, echo=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=4, fig.align='center',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r load_libs}
library(readr)
library(dplyr)
library(reshape2)
library(stringr)
library(ggplot2)
library(ggthemes)
library(RColorBrewer)
library(shiny)
```

```{r settings_functions}
myCbPal <- colorblind_pal()(8)
myCbPal[c(1, 3, 6)] <- myCbPal[c(6, 1, 3)]
myCbPal[3] <- "#666666"

source("functions.R")
```

<div style = "font-size:90%;">
*James Eddy --- September 11, 2015*
</div>

\  

This year, I decided it would be fun to produce some data-driven content
throughout the season. As a starting point, I've put together a little analysis
of our auction draft results. Everything in the report below (including this
page) was generated in **R**. All code and data are available on 
**[GitHub](https://github.com/jaeddy/ffb/blob/master/draftanalysis2015)**.

\  

-----

### The data

+ **draft_results.csv:** auction draft results; recorded during the draft on
8/25/2015
+ **espn_projections.csv:** ESPN projections; accessed on 9/3/2015 using 
the **R** script forked from this 
[repo](https://github.com/dadrivr/FantasyFootballAnalyticsR) and available 
[here](https://github.com/jaeddy/FantasyFootballAnalyticsR/blob/master/R%20Scripts/Projections/ESPN%20Projections.R) 
(after adjusting league settings)  
+ **ffa_projections.csv:** weighted projections from an aggregate of fantasy
football sites, generated by 
**[Fantasy Football Analytics (FFA)](fantasyfootballanalytics)**; downloaded 
from 
[http://apps.fantasyfootballanalytics.net/projections](http://apps.fantasyfootballanalytics.net/projectionson)
on 9/3/2015 (after adjusting league settings)

Each of the above files (in the versions used below) can be accessed here:
[https://github.com/jaeddy/ffb/tree/master/draftanalysis2015/data](https://github.com/jaeddy/ffb/tree/master/draftanalysis2015/data)

\  

##### **Disclaimer:**

The data represent projections and trends up to 9/2/2015. 
Higher impact changes (i.e., the nullification of Brady's suspension) between
our draft date and Week 1 aren't reflected here, but smaller changes (e.g., 
players moving up and down the depth chart towards the end of preseason) 
probably are to some extent. Because I don't have projections etc. from 8/25, 
this is my best approximation for comparing how teams looked coming out of
the draft.

```{r load_data, cache=TRUE}
# Load draft results (and drop the first column)
rosters <- read_csv("data/draft_results.csv") %>% .[, -1] %>% 
  rename(owner = team, team = position, position = playerTeam)

# Load ESPN projections (and drop the first column)
espnProjections <- read_csv("data/espn_projections.csv") %>% .[, -1]

# Load FFA projections
ffaProjections <- read_csv("data/ffa_projections.csv")
# replace "null"s with NAs
ffaProjections[ffaProjections == "null"] <- NA
```

\  

#### Prepping the data

Before I getting started with any sort of analysis, I spent some modifying and
cleaning up the data. Changes included...

+ Updating teams of players listed as **FA** in one or more of the projection
sources (e.g., **Chris Johnson**)  
+ Fixing data entry errors from my record of the draft  
+ Adjusting ESPN's QB projections so that they're based on 6pts/passing TD
instead of 4pts
+ Correcting some other dumb formatting crap with the ESPN projections

\  

In order to get league rosters and draft results lined up with projections and
other values, I had to do some additional munging and formatting with the data.
I didn't alter, scale, or weight player data in any way that might bias 
comparisons between teams. I've left the messy details out here, but you're 
free to check out the 
[code](https://github.com/jaeddy/ffb/blob/master/draftanalysis2015/draftanalysis2015.Rmd)
, if you want to learn more.

```{r update_data, cache=TRUE}
if (!file.exists("draft_data.csv")) {
  # Assign draft-time FAs to their current teams
rosters <- rosters %>% 
  mutate(team = ifelse(player == "Chris Johnson", "ARI", team),
         team = ifelse(player == "Reggie Wayne", "NE", team))

# Correct data entry error for Shep's team
rosters <- rosters %>% 
  mutate(paid = ifelse(player == "DeAndre Hopkins", 25, paid))

# Add 2 points for every passing TD for QBs for ESPN projections; fix ESPN's
# abbreviation for ARI
espnProjections <- espnProjections %>% 
  mutate(points = ifelse(pos == "QB", points + 2 * passTds, points),
         team_espn = str_replace_all(team_espn, "ARZ", "ARI")) 

# Replace DST names
espnProjections <- espnProjections %>%
  left_join(ffaProjections %>% 
              filter(position == "DST") %>% 
              select(playername, pos = position, team_espn = team)) %>% 
  mutate(name = ifelse(pos == "DST", str_to_upper(playername), name))
}
```

```{r combine_data, cache=TRUE}
str_uniform <- Vectorize(function(string) {
  string %>% 
    str_to_upper() %>% 
    str_replace_all(" |\\.", "")
})

if (!file.exists("draft_data.csv")) {
  # Keep owner, slot, player cost from rosters
  rostersSub <- rosters %>% 
    select(owner, slot, player, team, draftValue = paid) %>% 
    mutate(player = str_uniform(player))
  
  # Keep player, player info, player rankings, player cost, and player points
  # from ffaProjections
  ffaProjectionsSub <- ffaProjections %>% 
    select(player = playername, position, team, vor, 
           overallECR, overallRank, positionRank, risk, avgValue = auctionValue,
           ffaPoints = points, ffaCeiling = upper, ffaFloor = lower) %>% 
    mutate(playerName = player,
           player = str_uniform(player))
  
  # Keep player and player points from espnProjections
  espnProjectionsSub <- espnProjections %>% 
    select(player = name, team = team_espn, espnPoints = points)
  
  draftDat <- rostersSub %>% 
    left_join(ffaProjectionsSub) %>% 
    left_join(espnProjectionsSub) %>% 
    distinct(player, team)
  
  # Manually update Nate Washington's ESPN projection; replace NAs with 0s
  draftDat <- draftDat %>% 
    mutate(espnPoints = ifelse(player == "NATEWASHINGTON", 89.7, espnPoints),
           espnPoints = ifelse(is.na(espnPoints), 0, espnPoints),
           ffaPoints = ifelse(is.na(ffaPoints), 0, ffaPoints),
           position = ifelse(is.na(position), slot, position),
           avgValue = ifelse(is.na(avgValue), 0, avgValue))
  write_csv(draftDat, "draft_data.csv")
} else {
  draftDat <- read_csv("draft_data.csv")
}
```

\  

----- 

### Roster overview

To get started, I decided to just take a look at the composition of each team
after the draft. Below, you can see how many players were drafted at each 
position by individual teams relative to league averages.

```{r count_positions}
draftDat <- draftDat %>% 
  mutate(position = factor(position, 
                           levels = c("QB", "RB", "WR", "TE", "DST", "K"))) %>% 
  group_by(owner, position) %>% 
  mutate(posCount = n()) %>% 
  ungroup()
```

\  

Use the toggle to switch between graphs separated by owner or by position.

```{r compare_position_counts_by_owner}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
             radioButtons("groupBy", "Group by:", c("position", "owner"), 
                          inline = TRUE),
             hr(),
             checkboxInput("includeAvgCounts", "Show league averages"))),
      column(9,
             plotOutput("positionCounts"))
    )
  ),

  server = function(input, output) {
    output$positionCounts <- renderPlot({
      groupBy <- input$groupBy
      includeAvgCounts <- input$includeAvgCounts
      
      data <- draftDat %>% 
          group_by(position) %>% 
          mutate(avgCount = mean(posCount)) %>% 
          ungroup()
      
      p <- data %>% 
        ggplot(aes(x = owner, y = posCount))
      
      if (groupBy == "position") {
        p <- data %>% 
          ggplot(aes(x = owner, y = posCount))
        if (includeAvgCounts) {
          p <- p +geom_hline(aes(yintercept = avgCount), 
                             size = 1, colour = myCbPal[3])
        }
        p <- p + facet_wrap(~ position)
      } else if (groupBy == "owner") {
        p <- data %>% 
          ggplot(aes(x = position, y = posCount))
        if (includeAvgCounts) {
          p <- p + geom_errorbar(aes(y = avgCount, ymin = avgCount, 
                                     ymax = avgCount),
                                 size = 1, colour = myCbPal[3])
        }
        p <- p + facet_wrap(~ owner, nrow = 2)
      }
      
      p <- p + stat_summary(aes(fill = posCount), fun.y = max, 
                            geom = "bar", position = "dodge", alpha = 0.7) + 
        theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
        scale_y_continuous(breaks = 1:9) +  
        scale_fill_gradient(low = myCbPal[6], high = myCbPal[1], 
                            guide = FALSE) +
        ylab("# players")
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

##### **Some thoughts on position counts:**

+ Shep has taken his hard-on for RBs to a new extreme, drafting a total of 9
backs this year  
+ Kevin appears to have a similar (but, of course, smaller) boner for WRs with 9  
+ On the other end of the spectrum, Billy, Kevin, and Toby each drafted only 3
RBs  
+ Not surprisingly, Shep only had roster space for 3 WRs, and I apparently 
decided I didn't need any real depth at the position...  
+ Of the two teams that drafted 3 QBs, 1 of Billy's is bad (**Jay Cutler**),
and the other is/was **Tim Tebow**  
+ Toby drafted 3 potential top-5 QBs (though **Tom Brady** was admittedly more
of a risk at the time) --- nobody knows why  
+ Nobody drafted more than 1 kicker --- good job

\  

-----  

### Spending

On to more interesting stuff...

ESPN has a table that shows average auction values for players across all 
leagues using their system (though I had to actually access these values 
through the FFA app). While these average values don't take into account
the specific size and settings of our league<sup>1</sup>, they provide context
for exploring the spending habits of individual owners and the league as a 
whole.

<div style = "font-size:80%;">
<sup>1</sup>The auction values listed in the actual online draft app --- which 
I recall were at least a bit closer to what people actually spent --- are 
impossible to find.
</div>

```{r format_draft_cost_data}
draftCostDat <- draftDat %>% 
  melt(measure.vars = c("avgValue", "draftValue"),
       variable.name = "valueSource", value.name = "cost")
```

\  

#### Overall spending vs. ESPN average

Directly comparing dollars paid for all individual players to their average 
auction values on ESPN, we get a nice picture of overall spending. The 
dashed black line in the graph represents perfect agreement with the ESPN
average; if points fall above that line, it means someone paid more than
average (and vice versa, if a point falls below the line). I also fit a simple 
line to the data, which shows that --- as a league --- we tend to spend more 
on players than the averge bidder on ESPN. This seems to be especially 
true for the most expensive players (i.e., top RBs, WRs, and QBs).

\  

Use the drop-down to highlight the points for a specific team. You can also see
how the spending trend for that owner compares to the league trend.

```{r compare_overall_spending}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
             selectInput("highlightTeam", "Highlight team:", 
                         c("None", unique(rosters$owner))),
             hr(),
             checkboxInput("includeFit", "Show fit"))),
      column(9,
             plotOutput("overallSpending"))
    )
  ),

  server = function(input, output) {
    output$overallSpending <- renderPlot({
      highlightTeam <- input$highlightTeam
      includeFit <- input$includeFit
      
      data <- draftDat %>% 
        mutate(highlight = factor(ifelse(owner %in% highlightTeam,
                                         owner, "League")) %>% 
                 relevel("League"))
      
      p <- data %>% 
        ggplot(aes(x = avgValue, y = draftValue)) +
        geom_abline(intercept = 0, slope = 1, 
                    colour = myCbPal[3], size = 1, linetype = 2) +
        geom_point(aes(fill = highlight),
                   shape = 21, size = 3, colour = "white", alpha = 0.6)
      
      if (includeFit) {
        p <- p + geom_smooth(aes(colour = highlight), method = "lm",
                             size = 1, alpha = 0)
      }
      
      if (highlightTeam != "None") {
        p <- p + geom_point(fill = myCbPal[2], 
                            shape = 21, size = 4, colour = "white",
                            aes(alpha = highlight))
      }
      
      p <- p + scale_alpha_manual(values = c(0, 1), guide = FALSE) +
        scale_fill_manual(values = myCbPal, 
                          guide = guide_legend(title = "Spending vs. ESPN")) +
        scale_colour_manual(values = myCbPal, 
                            guide = guide_legend(title = "Spending vs. ESPN")) +
        ylab("Actual bid") +
        xlab("ESPN avg.") +
        xlim(c(-5, 60)) +
        ylim(c(-5, 67))
      
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

+ Based on the fairly simple linear fits, pretty much everyone in the league 
spends more than the ESPN average --- again, this could just be an artifact
of league size and scoring  
+ Billy came the closest to matching ESPN values (on average)  
+ Shep was the thriftiest owner in the draft, spending no more than 25 for any
single player; while he overpaid relative to average values on the cheaper end,
his trend would actually have him underpaying ESPN owners at higher costs 
(if he had any)

\  

#### Spending by player ranking

The FFA projections also include overall and position rankings, based on
a weighted average of multiple fantasy sites and tailored to our league 
settings. I took another look at ESPN average and Jeff Cup actual auction 
values to see how spending patterns might vary based on player rank. While we
tend to spend more on top ranked players, there's less difference at the 
replacement level.

The trend also depends on position. Player values track pretty consistently
with ESPN averages for TEs. We also apparently spend less on average for
DSTs and Ks --- probably because we're not assholes.

\  

You can toggle between individual and all positions below to check out the
trends. Use the slider bar to set the minimum rank, if you want a more zoomed
in view.

```{r compare_league_cost_by_rank}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
             radioButtons("positionFilter", "Choose position:", 
                          c("all", levels(draftDat$position))),
             sliderInput("rankCutoff", "Choose rank cutoff:", 10, 400, 100, 10),
             hr(),
             checkboxInput("includeFit2", "Show fit"))),
      column(9,
             plotOutput("spendingByRank"))
    )
  ),
  
  server = function(input, output) {
    
    output$spendingByRank <- renderPlot({
      if (input$positionFilter == "all") {
        positionFilter <- unique(draftDat$position)
        spender <- "League"
        rankType <- "overallRank"
        xlabel <- "Overall rank"
      } else {
        positionFilter <- input$positionFilter
        spender <- positionFilter
        rankType <- "positionRank"
        xlabel <- "Position rank"
      }
      
      rankCutoff <- input$rankCutoff
      includeFit <- input$includeFit2
      
      data <- draftCostDat %>% 
        rename_(rank = rankType) %>% 
        filter(position %in% positionFilter,
               rank <= rankCutoff)
      
      p <- data %>% 
        ggplot(aes(x = rank, y = cost))
      
      if (includeFit) {
        p <- p + geom_smooth(aes(colour = valueSource), size = 1, alpha = 0)
      }
      
      p <- p + geom_point(aes(fill = valueSource),
                          shape = 21, size = 3, colour = "white", alpha = 0.6) +
        scale_fill_manual(values = myCbPal, 
                          guide = guide_legend(title = "Spender"),
                          labels = c("ESPN", spender)) +
        scale_colour_manual(values = myCbPal, 
                            guide = guide_legend(title = "Spender"),
                            labels = c("ESPN", spender)) +
        ylab("Auction value") +
        xlab(xlabel) +
        ylim(c(0, max(data$cost) + 2))
      
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

\  

#### Position spending by owner

If you want to check out how much each owner spent on each position, you can
take a look at the graph below. The orange bars show how spending at each
position stacked up against what ESPN users thought the same group of players 
were worth on average (blue bars). You can also see how much each owner paid
for positions relative to the rest of the league.

\  

I won't say much about this one, but go ahead and explore for yourself.

```{r compare_owner_cost_by_position}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
             selectInput("ownerFilter1", "Choose owner:", 
                         unique(rosters$owner)),
             hr(),
             checkboxInput("includeAvgCost", "Show league averages"),
             checkboxInput("includeIndividual", "Show individual player costs"))),
      column(9,
             plotOutput("spendingByPosition"))
    )
  ),
  
  server = function(input, output) {
    output$spendingByPosition <- renderPlot({
      ownerFilter <- input$ownerFilter1
      spender <- ownerFilter
      includeAvgCost <- input$includeAvgCost
      includeIndividual <- input$includeIndividual
      
      data <- draftCostDat %>% 
        group_by(position, valueSource) %>% 
        mutate(avgCost = mean(cost)) %>%
        ungroup() %>% 
        filter(owner %in% ownerFilter)
      
      p <- data %>% 
        ggplot(aes(x = position, y = cost))
      
      if (includeAvgCost) {
        p <- p + geom_errorbar(aes(y = avgCost, ymin = avgCost, ymax = avgCost,
                                   alpha = valueSource), 
                               size = 1, colour = myCbPal[3]) +
          scale_alpha_manual(values = c(0, 1), guide = FALSE)
      }
      
      p <- p + stat_summary(aes(fill = valueSource), fun.y = mean, 
                            geom = "bar", position = position_dodge(), 
                            alpha = 0.7) +
        scale_fill_manual(values = myCbPal, 
                          guide = guide_legend(title = "Position avg.",
                                               override.aes = list(shape = NA)),
                          labels = c("ESPN", spender)) +
        ylab("Auction value") +
        xlab("Position") +
        ylim(c(0, 65))
      
      if (includeIndividual) {
        p <- p + geom_point(aes(fill = valueSource), 
                            shape = 21, size = 3, alpha = 0.7, 
                            colour = "white",
                            position = position_dodge(width = 0.75)) +
          geom_point(aes(colour = valueSource), 
                     size = 3, alpha = 0,
                     position = position_dodge(width = 0.75)) +
          scale_colour_manual(values = myCbPal, 
                              guide = guide_legend(title = "Player cost",
                                                   override.aes = 
                                                     list(alpha = 0.7)),
                              labels = c("ESPN", spender))
      }
      
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

\  

#### Individual player spending by owner

This is also fairly self-explanatory --- switch between teams to see how the
amount paid for individual players compared to ESPN average auction values.

```{r compare_owner_costs_by_player}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
             selectInput("ownerFilter2", "Choose owner:", 
                         unique(rosters$owner)))),
      column(9,
             plotOutput("spendingByPlayer"))
    )
  ),
  
  server = function(input, output) {
    output$spendingByPlayer <- renderPlot({
      ownerFilter <- input$ownerFilter2
      spender <- ownerFilter
      
      data <- draftCostDat %>% 
        filter(owner %in% ownerFilter) %>% 
        ungroup()
      
      playerOrder <- data %>% 
        group_by(playerName) %>% 
        summarise(costOrder = mean(cost)) %>% 
        arrange(desc(costOrder)) %>% 
        select(playerName) %>% 
        unlist()
      
      p <- data %>% 
        mutate(playerName = factor(playerName, levels = playerOrder)) %>% 
        ggplot(aes(x = playerName, y = cost)) +
        geom_bar(aes(fill = valueSource), alpha = 0.7, 
                 position = "dodge", stat = "identity") +
        theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
        scale_fill_manual(values = myCbPal, 
                          guide = guide_legend(title = "Spender"),
                          labels = c("ESPN", spender)) +
        ylab("Auction value") +
        ylim(c(0, 65)) +
        xlab("Player")
      
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

\  

-----  

### Projected points

Ah... finally to the most important part: projections!

For each team, I calculated the "optimal" roster --- that is, the combination
of players that would yield the greatest amount of points for *starters* only,
based on projections from either ESPN or FFA<sup>2</sup>. Keep in mind, 
projections here are for *total points* over the course of the season, and 
don't take into  account week-to-week scoring, matchups, suspensions, bye 
weeks, etc.

<div style = "font-size:80%;">
<sup>2</sup>Note: just a reminder that FFA projections are based on a weighted 
average of several fantasy football sites, including ESPN. One could argue that 
a "wisdom of the crowds" prediction is likely to be more accurate, but we'll 
just have to wait and see...
</div>

\  

The graph below shows how many points each team could hypothetically squeeze
out of a starting lineup, based on the team they drafted. 

```{r calculate_optimum_rosters}
if (file.exists("optimum_rosters.csv")) {
  optRosters <- read_csv("optimum_rosters.csv")
} else {
  optRostersFFA <- optimize_rosters(draftDat, "ffaPoints") %>% 
    mutate(pointSource = "FFA")
  optRostersESPN <- optimize_rosters(draftDat, "espnPoints") %>% 
    mutate(pointSource = "ESPN")
  optRosters <- bind_rows(optRostersFFA, optRostersESPN)
  write_csv(optRosters, "optimum_rosters.csv")
}
```

```{r compare_projected_points_by_position}
shinyApp(
  ui = fluidPage(
    fluidRow(
      column(3,
             br(),
             wellPanel(
               radioButtons("selectedSource", "Choose projections source:",
                            c("ESPN", "FFA"), inline = TRUE),
               checkboxGroupInput("positionFilter2", "Include position(s):", 
                                  levels(draftDat$position), 
                                  levels(draftDat$position)),
               hr(),
               checkboxInput("includeAvgPoints", "Show league average"))),
      column(9,
             plotOutput("projectedPoints"))
    )
  ),
  
  server = function(input, output) {
    output$projectedPoints <- renderPlot({
      positionFilter <- input$positionFilter2
      selectedSource <- input$selectedSource
      includeAvgPoints <- input$includeAvgPoints
      
      data <- optRosters %>%
        filter(pointSource == selectedSource,
               position %in% positionFilter) %>% 
        group_by(owner, pointSource) %>% 
        summarise(totalPoints = sum(points))
      
      p <- data %>% 
        ggplot(aes(x = owner, y = totalPoints))
      
      if (includeAvgPoints) {
        p <- p + geom_hline(aes(yintercept = mean(totalPoints)), 
                            size = 1, colour = myCbPal[3])
      }
      
      p <-p + geom_bar(aes(fill = totalPoints), stat = "identity", 
                       position = "dodge", alpha = 0.8) +
        geom_text(aes(label = round(totalPoints, 2), y = totalPoints * .95),
                  position = "dodge", angle = -90, hjust = 0, size = 4) + 
        scale_fill_gradient(low = myCbPal[6], high = myCbPal[1], 
                            guide = FALSE) +
        theme(axis.text.x = element_text(angle = -90, hjust = 0)) +
        ylab("Projected season points") +
        xlab("Owner")
      
      return(p)
    }, height = 500, res = 96)
  },
  options = list(height = 520)
)
```

\  

-----

### Conclusions

I'm going to win. The rest of you can suck it. Especially Tony.

\  

----- 

#### **Session info**
<div style = "font-size:80%;">
```{r session_info}
sessionInfo()
```
</div>
